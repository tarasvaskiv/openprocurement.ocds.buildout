modules:
  input:
    module: wishbone.module.input.couchdbpoller
    arguments:
      couchdb_url: "{{ couchdb_from_url }}"
      seqfile: {{ parts.buildout.directory }}/var/neoj4seqfile

  fanout:
    module: wishbone.module.flow.fanout

  export:
    module: wishbone.module.process.galleon
    arguments:
      schema: {{ schema }}
      mapping: {{ mapping }}
      tagger: ocds

  modefilter:
    module: wishbone.module.flow.jqfilter
    arguments:
      conditions:
      - name: Filter doc_mode
        expression: '.mode == "test"'
        queue: no_match
      - name: Filter TESTING title
        expression: '.title | test(".+test.+"; "i")'
        queue: no_match
      - name: Filter TESTING title
        expression: '.title | test(".+тест.+"; "i")'
        queue: no_match
      - name: Get only tenders
        expression: '.doc_type == "Tender"'
        queue: outbox

  viewfilter:
    module: wishbone.module.flow.viewfilter
    arguments:
      couchdb_url: "{{ couchdb_to_url }}"
      view: "{{ filter_view }}"
      view_expression: '[.id, "ocds-be6bcu-"+.tenderID]'
      conditions:
      - name: dateModified filter
        expression: '.[0].value < .[1].dateModified'

  output:
    module: wishbone.module.output.neo4jpush
    arguments:
      host: "{{ neo4j_host }}"
      port: "{{ neo4j_port }}"
      user: "{{ neo4j_user }}"
      password: "{{ neo4j_password }}"


routingtable:
  - input.outbox -> modefilter.inbox
  - modefilter.outbox -> viewfilter.inbox
  - viewfilter.outbox -> export.inbox
  - export.outbox -> output.inbox